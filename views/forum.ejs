<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- تحسين SEO: إضافة وصف وعنوان ديناميكي -->
  <meta name="description" content="المنتدى الإبداعي على Colorizer - شارك منشوراتك، اعرض إعلاناتك، وتواصل مع المبدعين." />
  <meta name="keywords" content="منتدى, Colorizer, تصميم, إبداع, مشاركات" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow" />
  <title>المنتدى | Colorizer</title>
  <link rel="stylesheet" href="/css/headeraction.min.css" media="all" />
  <link rel="stylesheet" href="/css/forum.css" media="all" />
  <!-- تحسين الأداء: تحميل Google Fonts و FontAwesome مع تأخير -->
  <link rel="dns-prefetch" href="//fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Tajawal:wght@700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" media="print" onload="this.media='all'" />

  <!-- تحسين الأداء: إضافة SweetAlert2 مضغوط مع defer -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <!-- تحسين الأداء: تحميل مسبق لصورة المستخدم -->
  <link rel="preload" href="<%= currentUserAvatar ? (currentUserAvatar.includes('/uploads/avatars/') ? currentUserAvatar : '/uploads/avatars/' + currentUserAvatar) : '/uploads/images/pngwing.com.png' %>" as="image" />

  <!-- Open Graph لتحسين المشاركة على الشبكات الاجتماعية -->
  <meta property="og:title" content="المنتدى | Colorizer" />
  <meta property="og:description" content="المنتدى الإبداعي على Colorizer - شارك منشوراتك، اعرض إعلاناتك، وتواصل مع المبدعين." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.colorizer.com/forum" />
  <meta property="og:image" content="<%= currentUserAvatar ? (currentUserAvatar.includes('/uploads/avatars/') ? currentUserAvatar : '/uploads/avatars/' + currentUserAvatar) : '/uploads/images/pngwing.com.png' %>" />
  <meta property="og:image:alt" content="صورة المستخدم في المنتدى" />
  <meta property="og:site_name" content="Colorizer" />
  <meta property="og:locale" content="ar_AR" />

  <!-- Twitter Card لتحسين المشاركة على تويتر -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="المنتدى | Colorizer" />
  <meta name="twitter:description" content="المنتدى الإبداعي على Colorizer - شارك منشوراتك، اعرض إعلاناتك، وتواصل مع المبدعين." />
  <meta name="twitter:image" content="<%= currentUserAvatar ? (currentUserAvatar.includes('/uploads/avatars/') ? currentUserAvatar : '/uploads/avatars/' + currentUserAvatar) : '/uploads/images/pngwing.com.png' %>" />

  <!-- تحسين الأداء: إضافة DNS Prefetch و Preconnect -->
  <link rel="dns-prefetch" href="//www.colorizer.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

  <!-- تحسين الأمان -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com; script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com 'unsafe-inline'; style-src 'self' https://cdnjs.cloudflare.com https://fonts.googleapis.com 'unsafe-inline'; img-src 'self' data: https://*; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com;" />
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />

</head>
<body>
  <%- include('partials/headerhome') %>

  <div class="header" role="navigation" aria-label="شريط التنقل العلوي">
    <nav id="colorNav">
      <ul>
        <li>
          <a href="#" class="dropdown-toggle fa fa-cog" aria-label="خيارات المستخدم" aria-expanded="false" aria-controls="dropdown-menu"></a>
          <ul class="dropdown-menu" role="menu" id="dropdown-menu">
            <% if (locals.isAdmin) { %>
              <li><a href="/admin/dashboard" aria-label="التحكم"><i class="fas fa-user-shield" aria-hidden="true"></i> التحكم</a></li>
            <% } %>
            <li>
              <form action="/logout" method="POST" id="logout-form">
                <button type="submit" style="background: none; border: none; padding: 0; width: 100%; text-align: right;" aria-label="تسجيل الخروج">
                  <i class="fas fa-sign-out-alt" aria-hidden="true"></i> تسجيل الخروج
                </button>
              </form>
            </li>
            <li><a href="/change-password" aria-label="تغيير كلمة المرور"><i class="fas fa-lock" aria-hidden="true"></i> تغيير كلمة المرور</a></li>
            <li><a href="/updateProfile" aria-label="تعديل الملف الشخصي"><i class="fas fa-user-edit" aria-hidden="true"></i> تعديل الملف الشخصي</a></li>
          </ul>
        </li>
      </ul>
    </nav>
    <a href="/friends" aria-label="الأصدقاء"><i class="fas fa-users"></i></a>
    <a href="/profile" aria-label="الملف الشخصي"><i class="fas fa-user"></i></a>
    <a href="/notifications" class="notification-icon" id="notifications-icon" aria-label="الإشعارات">
      <i class="fas fa-bell"></i>
      <% if (locals.unreadCount > 0) { %>
        <span class="notification-count" id="unread-notifications-count"><%= locals.unreadCount %></span>
      <% } else { %>
        <span class="notification-count" id="unread-notifications-count" style="display: none;">0</span>
      <% } %>
    </a>
    <a href="/messages" class="notification-icon" id="messages-icon" aria-label="الرسائل">
      <i class="fas fa-message"></i>
      <% if (locals.unreadMessagesCount > 0) { %>
        <span class="notification-count" id="unread-messages-count"><%= locals.unreadMessagesCount %></span>
      <% } else { %>
        <span class="notification-count" id="unread-messages-count" style="display: none;">0</span>
      <% } %>
    </a>
    <a href="/forum" aria-label="المنتدى"><i class="fas fa-home"></i></a>
  </div>
  
  <!-- تحميل سكريبت socket.io مع defer لضمان تحميل DOM أولاً -->
  <script src="/socket.io/socket.io.js" defer></script>
  
  <script defer>
    // مستمع عام للأخطاء لمنع تأثيرها على واجهة المستخدم
    window.onerror = function(message, source, lineno, colno, error) {
      console.error("Error caught:", message);
      // يمكن إضافة إجراءات أخرى مثل إرسال الخطأ لسيرفر السجلات
      return true; // منع عرض الخطأ بشكل افتراضي
    };
  
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const socket = io();
        const userId = "<%= locals.userId || '' %>";
        const notificationsIcon = document.getElementById('notifications-icon');
        const messagesIcon = document.getElementById('messages-icon');
        const unreadNotificationsCount = document.getElementById('unread-notifications-count');
        const unreadMessagesCount = document.getElementById('unread-messages-count');
  
        if (userId) {
          socket.emit("join", userId);
        }
  
        fetch('/chat/unread-count', {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' }
        })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const initialCount = data.unreadMessagesCount || 0;
            unreadMessagesCount.textContent = initialCount;
            unreadMessagesCount.style.display = initialCount > 0 ? 'inline' : 'none';
          }
        })
        .catch(error => {
          console.error("Fetch unread count error:", error);
        });
  
        socket.on("newNotification", () => {
          let currentCount = parseInt(unreadNotificationsCount.textContent) || 0;
          currentCount++;
          unreadNotificationsCount.textContent = currentCount;
          unreadNotificationsCount.style.display = 'inline';
        });
  
        socket.on("newMessage", (message) => {
          if (message.receiver_id === userId && !message.is_read) {
            let currentCount = parseInt(unreadMessagesCount.textContent) || 0;
            currentCount++;
            unreadMessagesCount.textContent = currentCount;
            unreadMessagesCount.style.display = 'inline';
          }
        });
  
        notificationsIcon.addEventListener('click', async (e) => {
          e.preventDefault(); // منع التنقل التلقائي حتى يتم تنفيذ العملية بنجاح
          try {
            const response = await fetch('/notifications/mark-all-as-read', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' }
            });
            if (response.ok) {
              unreadNotificationsCount.textContent = '0';
              unreadNotificationsCount.style.display = 'none';
            }
            window.location.href = '/notifications';
          } catch (error) {
            console.error("Notifications error:", error);
          }
        });
  
        messagesIcon.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            const response = await fetch('/chat/mark-all-as-read', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' }
            });
            if (response.ok) {
              unreadMessagesCount.textContent = '0';
              unreadMessagesCount.style.display = 'none';
            }
            window.location.href = '/messages';
          } catch (error) {
            console.error("Messages error:", error);
          }
        });
  
        const logoutForm = document.getElementById('logout-form');
        if (logoutForm) {
          logoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              const response = await fetch('/logout', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
              });
              if (response.ok) {
                window.location.href = '/login';
              }
            } catch (error) {
              console.error("Logout error:", error);
            }
          });
        }
      } catch (err) {
        console.error("Initialization error:", err);
      }
    });
  </script>
  
  <nav class="mobile-nav">
    <div class="nav-item" data-link="/jobs"><i class="fas fa-briefcase"></i><span>الوظائف</span></div>
    <div class="nav-item" data-link="/ProjectSpace"><i class="fas fa-cogs"></i><span>المشاريع</span></div>
    <div class="nav-item" data-link="/my-posts"><i class="fas fa-blog"></i><span>المشاركات</span></div>
  </nav>
  
  <div class="all">
    <div class="right">
      <div class="right-header">
        <a href="/ProjectSpace" style="text-decoration:none; color:inherit;" aria-label="عرض المشاريع">
          <h2 style="cursor:pointer; text-align:center;">المشاريع</h2>
        </a>
      </div>
      <ul class="project-list">
        <% if (projects && projects.length > 0) { %>
          <% projects.forEach(function(project) { %>
            <li class="project-item" onclick="window.location.href='/projects/project/<%= project.id %>'">
              <div class="project-icon"><img src="/icons/project-plan.png" alt="أيقونة المشروع" style="width: 40px;height: 40px;" loading="lazy"></div>
              <div class="project-info">
                <span class="project-title"><%= project.title %></span>
                <span class="project-duration"><i class="fas fa-clock"></i> المدة: <%= project.duration %> يوم</span>
                <p class="project-description"><%= project.description %></p>
              </div>
            </li>
          <% }); %>
        <% } else { %>
          <li class="no-projects">لا توجد مشاريع متاحة.</li>
        <% } %>
      </ul>
      <style>
        .right-header h2 { font-size: 18px; margin-bottom: 15px; color: #333; }
        .project-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 15px; }
        .project-item { display: flex; align-items: center; padding: 15px; background: #e8f0fe; border-radius: 8px; transition: 0.3s; cursor: pointer; }
        .project-item:hover { background: #d0e2fd; transform: translateY(-2px); }
        .project-icon { font-size: 28px; color: #6B48FF; margin-right: 15px; }
        .project-info { text-align: right; flex: 1; }
        .project-title { font-size: 16px; font-weight: bold; color: #333; }
        .project-duration, .project-description { font-size: 14px; color: #555; margin-bottom: 5px; }
        .no-projects { text-align: center; font-size: 18px; color: #555; padding: 15px; background: #f4f4f9; border-radius: 8px; }
      </style>
    </div>
  
    <div class="center">
      <section>
        <div class="share">
          <form id="postForm" enctype="multipart/form-data">
            <div class="row">
              <textarea name="content" placeholder="اكتب محتوى المنشور هنا..." required></textarea>
              <a href="/profile?userId=<%= currentUserId %>">
                <img src="<%= currentUserAvatar ? (currentUserAvatar.includes('/uploads/avatars/') ? currentUserAvatar : '/uploads/avatars/' + currentUserAvatar) : '/uploads/images/pngwing.com.png' %>" 
                     alt="صورة المستخدم" loading="lazy" />
              </a>
            </div>
            <div class="hidden-form" id="hidden-form">
              <div id="image-preview"></div>
              <div class="file-input-container">
                <label for="postImages" class="file-input-label">
                  <i class="fas fa-cloud-upload-alt"></i> رفع صورة
                </label>
                <input type="file" id="postImages" name="postImages" accept="image/*" multiple />
              </div>
              <div class="share-buttons">
                <button type="button" class="cancel-btn" id="cancelPost" aria-label="إلغاء النشر">إلغاء</button>
                <button type="submit" class="share-btn" aria-label="نشر المنشور">نشر</button>
              </div>
            </div>
          </form>
        </div>
  
        <!-- قسم الإعلانات -->
        <div class="story-slider" id="storySlider">
          <div class="story-item add-story" id="addStory">
            <i class="fas fa-plus"></i>
            <span>اعلن عن نفسك</span>
          </div>
          <% if (ads && ads.length > 0) { %>
            <% ads.forEach(ad => { %>
              <div class="story-item" data-id="<%= ad.id %>" data-title="<%= ad.title %>" data-description="<%= ad.description %>" data-image="/uploads/ads/<%= ad.image %>">
                <% if (ad.image) { %>
                  <img src="/uploads/ads/<%= ad.image %>" alt="<%= ad.title %>" loading="lazy">
                <% } %>
                <img src="<%= ad.user_avatar ? (ad.user_avatar.includes('/uploads/avatars/') ? ad.user_avatar : '/uploads/avatars/' + ad.user_avatar) : '/uploads/images/pngwing.com.png' %>" 
                     class="avatar" 
                     alt="صورة <%= ad.user_name %>" loading="lazy">
                <span class="username"><%= ad.user_name %></span>
              </div>
            <% }); %>
          <% } %>
        </div>
  
        <div class="story-view" id="storyView">
          <div class="progress-container" id="progressContainer"></div>
          <div class="story-content">
            <img id="storyImage" src="" alt="الإعلان" loading="lazy">
            <div id="storyText" class="text"></div>
            <div id="adText" class="ad-text"></div>
          </div>
          <div class="close-btn" id="closeBtn">✕</div>
          <div class="nav-btn prev" id="prevBtn">‹</div>
          <div class="nav-btn next" id="nextBtn">›</div>
        </div>
  
        <div class="modal" id="addStoryModal">
          <div class="modal-content">
            <button class="close-modal" id="closeModalBtn">✕</button>
            <h3>إضافة إعلان</h3>
            <form id="addAdForm" enctype="multipart/form-data">
              <div class="file-input">
                <input type="file" id="storyImageInput" name="image" accept="image/*">
                <label for="storyImageInput"><i class="fas fa-cloud-upload-alt"></i> اختر صورة</label>
              </div>
              <input type="text" id="storyTitle" name="title" placeholder="عنوان الإعلان" required>
              <textarea id="storyDescription" name="description" placeholder="وصف الإعلان"></textarea>
              <button type="submit" id="submitStory">إضافة</button>
            </form>
          </div>
        </div>
  
        <div class="post-section">
          <% if (posts && posts.length > 0) { %>
            <% posts.forEach((post) => { %>
              <div class="post">
                <div class="post-header">
                  <div class="post-actions">
                    <% if (currentUserId && post.showEditDeleteButtons) { %>
                      <form action="/forum/post/<%= post.id %>/delete" method="POST">
                        <button type="submit" class="action-btn" aria-label="حذف المنشور"><i class="fas fa-trash-alt"></i></button>
                      </form>
                      <form action="/forum/post/<%= post.id %>/edit" method="GET">
                        <button type="submit" class="action-btn" aria-label="تعديل المنشور"><i class="fas fa-edit"></i></button>
                      </form>
                    <% } %>
                    <form action="/forum/post/<%= post.id %>/hide" method="POST">
                      <button type="submit" class="action-btn" aria-label="إخفاء المنشور"><i class="fas fa-eye-slash"></i></button>
                    </form>
                  </div>
                  <div class="person">
                    <div class="post-avatar">
                      <a href="/profile?userId=<%= post.user_id %>">
                        <img src="<%= post.user_avatar ? (post.user_avatar.includes('/uploads/avatars/') ? post.user_avatar : '/uploads/avatars/' + post.user_avatar) : '/uploads/images/pngwing.com.png' %>" 
                             alt="صورة <%= post.user_name %>" loading="lazy" />
                      </a>
                    </div>
                    <div class="post-user-info">
                      <p class="post-user-name">
                        <a href="/profile?userId=<%= post.user_id %>" style="text-decoration: none; color: inherit;">
                          <%= post.user_name %>
                        </a>
                      </p>
                      <span class="post-time">
                        <%= new Date(post.created_at).toLocaleString('ar-EG', { hour12: true }) %>
                      </span>
                    </div>
                  </div>
                </div>
  
                <div class="post-content">
                  <p><%= post.content %></p>
                </div>
  
                <div class="post-images">
                  <% if (post.image1 || post.image2 || post.image3 || post.image4) { %>
                    <% [post.image1, post.image2, post.image3, post.image4].forEach((image) => { %>
                      <% if (image) { %>
                        <img src="/uploads/images/<%= image %>" alt="صورة المنشور" class="post-image" loading="lazy" width="350" height="350" />
                      <% } %>
                    <% }); %>
                  <% } %>
                </div>
  
                <div class="post-footer">
                  <button class="like-button" data-post-id="<%= post.id %>" data-liked="<%= post.liked ? 'true' : 'false' %>">
                    <i class="fas fa-thumbs-up"></i><span class="like-count"><%= post.like_count || 0 %></span>
                  </button>
                  <button type="button" class="show-comments-btn" data-post-id="<%= post.id %>">
                    <i class="fas fa-comment"></i> تعليق
                    <span id="comment-count-<%= post.id %>" class="count">
                      <%= post.comment_count > 0 ? post.comment_count : 'لا تعليقات' %>
                    </span>
                  </button>
                  <form action="/forum/post/<%= post.id %>/share" method="POST">
                    <button type="submit"><i class="fas fa-share"></i><span class="count"><%= post.share_count || 0 %></span></button>
                  </form>
                </div>
  
                <div class="comments-section" id="comments-<%= post.id %>">
                  <form class="comment-form" data-post-id="<%= post.id %>" style="display: none;">
                    <div class="rowcomment">
                      <input type="text" name="content" placeholder="اكتب تعليقاً..." required />
                      <button type="submit"><i class="fas fa-paper-plane"></i></button>
                    </div>
                  </form>
                  <div class="comments-list" id="comments-list-<%= post.id %>">
                    <% if (post.comments && post.comments.length > 0) { %>
                      <% post.comments.forEach(comment => { %>
                        <div class="comment">
                          <a href="/profile?userId=<%= comment.user_id %>">
                            <img src="<%= comment.user_avatar ? (comment.user_avatar.includes('/uploads/avatars/') ? comment.user_avatar : '/uploads/avatars/' + comment.user_avatar) : '/uploads/images/pngwing.com.png' %>" 
                                 alt="صورة <%= comment.user_name %>" 
                                 class="comment-avatar" loading="lazy" />
                          </a>
                          <p>
                            <a href="/profile?userId=<%= comment.user_id %>" style="text-decoration: none; color: inherit;">
                              <strong><%= comment.user_name %></strong>
                            </a>: <%= comment.content %>
                          </p>
                        </div>
                      <% }); %>
                    <% } %>
                  </div>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <p class="text">لا توجد منشورات متاحة.</p>
          <% } %>
        </div>
      </section>
    </div>
  
    <div class="left">
      <div class="left-header">
        <a href="/jobs" style="text-decoration:none; color:inherit;" aria-label="عرض الوظائف">
          <h2 style="cursor:pointer; text-align: center;">الوظائف</h2>
        </a>
      </div>
      <ul class="job-list">
        <% if (jobs && jobs.length > 0) { %>
          <% jobs.forEach(function(job) { %>
            <li class="job-item" onclick="window.location.href='/job/<%= job.job_id %>'">
              <div class="job-icon"><img src="/icons/portfolio.png" alt="أيقونة الوظيفة" style="width: 40px;height: 40px;" loading="lazy"></div>
              <div class="job-info">
                <span class="job-title"><%= job.title %></span>
                <span class="job-location"><i class="fas fa-map-marker-alt"></i> <%= job.location %></span>
                <p class="job-description"><%= job.description %></p>
              </div>
            </li>
          <% }); %>
        <% } else { %>
          <li class="no-jobs">لا توجد وظائف متاحة.</li>
        <% } %>
      </ul>
      <style>
        .left-header h2 { font-size: 18px; margin-bottom: 15px; color: #333; }
        .job-list { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 15px; }
        .job-item { display: flex; align-items: center; padding: 15px; background: #e8f0fe; border-radius: 8px; transition: 0.3s; cursor: pointer; }
        .job-item:hover { background: #d0e2fd; transform: translateY(-2px); }
        .job-icon { font-size: 28px; color: #6B48FF; margin-right: 15px; }
        .job-info { text-align: right; flex: 1; }
        .job-title { font-size: 16px; font-weight: bold; color: #333; }
        .job-location, .job-description { font-size: 14px; color: #555; margin-bottom: 5px; }
        .no-jobs { text-align: center; font-size: 18px; color: #555; padding: 15px; background: #f4f4f9; border-radius: 8px; }
      </style>
    </div>
  </div>
  
  <script>
    const currentUserAvatar = "<%= currentUserAvatar ? (currentUserAvatar.includes('/uploads/avatars/') ? currentUserAvatar : '/uploads/avatars/' + currentUserAvatar) : '/uploads/images/pngwing.com.png' %>";
    const currentUserName = "<%= currentUserName || 'User' %>";
  
    document.addEventListener("DOMContentLoaded", () => {
      const textarea = document.querySelector('.share textarea');
      const hiddenForm = document.getElementById('hidden-form');
      const cancelPostBtn = document.getElementById('cancelPost');
      const postImagesInput = document.getElementById('postImages');
      const imagePreview = document.getElementById('image-preview');
      const postForm = document.getElementById('postForm');
      const addAdForm = document.getElementById('addAdForm');
  
      // إظهار النموذج المخفي عند النقر على textarea
      textarea.addEventListener('click', () => {
        hiddenForm.classList.add('active');
      });
  
      // إخفاء النموذج عند النقر على إلغاء
      cancelPostBtn.addEventListener('click', () => {
        textarea.value = '';
        hiddenForm.classList.remove('active');
        imagePreview.innerHTML = '';
        postImagesInput.value = '';
      });
  
      // معاينة الصور المرفوعة
      postImagesInput.addEventListener('change', () => {
        imagePreview.innerHTML = '';
        const files = postImagesInput.files;
        for (const file of files) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            const img = document.createElement('img');
            img.src = e.target.result;
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-image';
            removeBtn.innerHTML = '×';
            removeBtn.addEventListener('click', () => {
              imgContainer.remove();
              postImagesInput.value = ''; // إعادة تعيين الإدخال
            });
            imgContainer.appendChild(img);
            imgContainer.appendChild(removeBtn);
            imagePreview.appendChild(imgContainer);
          };
          reader.readAsDataURL(file);
        }
      });
  
      // إضافة منشور مع SweetAlert2
      postForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(postForm);
  
        try {
          const response = await fetch('/forum/post', {
            method: 'POST',
            body: formData,
            credentials: 'include',
            cache: 'no-store' // تحسين الأداء: منع التخزين المؤقت
          });
          const result = await response.json();
  
          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'تم!',
              text: result.message,
              confirmButtonText: 'موافق',
              confirmButtonColor: '#6B48FF',
            }).then(() => {
              location.reload(); // إعادة تحميل الصفحة لعرض المنشور الجديد
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'خطأ',
              text: result.message,
              confirmButtonText: 'موافق',
              confirmButtonColor: '#FF5C5C',
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'حدث خطأ غير متوقع!',
            confirmButtonText: 'موافق',
            confirmButtonColor: '#FF5C5C',
          });
        }
      });
  
      // إضافة تعليق مع SweetAlert2
      document.querySelectorAll(".comment-form").forEach((form) => {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const postId = form.getAttribute("data-post-id");
          const commentContent = form.querySelector("input[name='content']").value.trim();
          if (!commentContent) return;
  
          try {
            const response = await fetch(`/forum/comments/${postId}/add`, {
              method: "POST",
              headers: { "Content-Type": "application/json", "Cache-Control": "no-store" },
              credentials: 'include',
              body: JSON.stringify({ content: commentContent }),
            });
            const result = await response.json();
  
            if (result.success) {
              Swal.fire({
                icon: 'success',
                title: 'تم!',
                text: 'تم إضافة التعليق بنجاح!',
                confirmButtonText: 'موافق',
                confirmButtonColor: '#6B48FF',
              });
              form.querySelector("input[name='content']").value = "";
              await loadComments(postId);
              const commentCountElement = document.getElementById(`comment-count-${postId}`);
              commentCountElement.textContent = parseInt(commentCountElement.textContent) + 1 || 1;
            } else {
              Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: result.message,
                confirmButtonText: 'موافق',
                confirmButtonColor: '#FF5C5C',
              });
            }
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'خطأ',
              text: 'حدث خطأ غير متوقع!',
              confirmButtonText: 'موافق',
              confirmButtonColor: '#FF5C5C',
            });
          }
        });
      });
  
      // إضافة إعلان مع SweetAlert2
      addAdForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(addAdForm);
  
        try {
          const response = await fetch('/forum/ad', {
            method: 'POST',
            body: formData,
            credentials: 'include',
            cache: 'no-store' // تحسين الأداء: منع التخزين المؤقت
          });
          const result = await response.json();
  
          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'تم!',
              text: result.message,
              confirmButtonText: 'موافق',
              confirmButtonColor: '#6B48FF',
            }).then(() => {
              const newAd = document.createElement('div');
              newAd.classList.add('story-item');
              newAd.dataset.id = result.adId;
              newAd.dataset.title = formData.get('title');
              newAd.dataset.description = formData.get('description');
  
              if (result.filename) {
                const imageUrl = `/uploads/ads/${result.filename}`;
                newAd.dataset.image = imageUrl;
                newAd.innerHTML = `
                  <img src="${imageUrl}" alt="${formData.get('title')}" loading="lazy">
                  <img src="${currentUserAvatar}" class="avatar" alt="${currentUserName}" loading="lazy">
                  <span class="username">${currentUserName}</span>
                `;
              } else {
                newAd.innerHTML = `
                  <img src="${currentUserAvatar}" class="avatar" alt="${currentUserName}" loading="lazy">
                  <span class="username">${currentUserName}</span>
                `;
              }
  
              storySlider.insertBefore(newAd, addStoryBtn.nextSibling);
              stories = Array.from(document.querySelectorAll('.story-item:not(.add-story)'));
              addStoryModal.classList.remove('show');
              addAdForm.reset();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'خطأ',
              text: result.message,
              confirmButtonText: 'موافق',
              confirmButtonColor: '#FF5C5C',
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'حدث خطأ غير متوقع!',
            confirmButtonText: 'موافق',
            confirmButtonColor: '#FF5C5C',
          });
        }
      });
  
      // منطق زر الإعجاب
      document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', async function() {
          const postId = this.getAttribute('data-post-id');
          const liked = this.getAttribute('data-liked') === 'true';
  
          try {
            const response = await fetch(`/forum/toggle-like/${postId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', "Cache-Control": "no-store" },
              credentials: 'include',
              body: JSON.stringify({ liked: !liked }),
            });
  
            const data = await response.json();
            if (data.success) {
              this.querySelector('.like-count').textContent = data.likeCount;
              this.setAttribute('data-liked', data.liked);
              this.classList.toggle('liked', data.liked);
            } else {
              console.error('Error toggling like:', data.message);
            }
          } catch (err) {
            console.error('Error in like toggle:', err);
          }
        });
      });
  
      // منطق التعليقات
      document.querySelectorAll(".show-comments-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const postId = btn.getAttribute("data-post-id");
          const commentsSection = document.getElementById(`comments-${postId}`);
          const commentsList = commentsSection.querySelector(".comments-list");
          const commentForm = commentsSection.querySelector(".comment-form");
  
          commentsSection.classList.toggle("active");
  
          if (commentsSection.classList.contains("active")) {
            await loadComments(postId);
            commentForm.style.display = "block";
          } else {
            commentsList.innerHTML = "";
            commentForm.style.display = "none";
          }
        });
      });
  
      async function loadComments(postId) {
        const commentsList = document.getElementById(`comments-list-${postId}`);
        try {
          const response = await fetch(`/forum/comments/${postId}`, {
            method: "GET",
            credentials: 'include',
            cache: 'no-store' // تحسين الأداء: منع التخزين المؤقت
          });
          const result = await response.json();
          if (result.success) {
            commentsList.innerHTML = result.comments
              .map(comment => `
                <div class="comment">
                  <a href="/profile?userId=${comment.user_id}">
                    <img src="${comment.user_avatar ? (comment.user_avatar.includes('/uploads/avatars/') ? comment.user_avatar : '/uploads/avatars/' + comment.user_avatar) : '/uploads/images/pngwing.com.png'}" 
                         alt="${comment.user_name}" 
                         class="comment-avatar" loading="lazy" />
                  </a>
                  <p>
                    <a href="/profile?userId=${comment.user_id}" style="text-decoration: none; color: inherit;">
                      <strong>${comment.user_name}</strong>
                    </a>: ${comment.content}
                  </p>
                </div>
              `)
              .join("");
            const commentCountElement = document.getElementById(`comment-count-${postId}`);
            commentCountElement.textContent = result.comments.length > 0 ? result.comments.length : 'لا تعليقات';
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }
  
      // منطق التنقل في القائمة السفلية
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const link = item.getAttribute('data-link');
          if (link) window.location.href = link;
        });
      });
  
      // منطق الإعلانات
      const addStoryBtn = document.getElementById('addStory');
      const addStoryModal = document.getElementById('addStoryModal');
      const storySlider = document.getElementById('storySlider');
      const storyView = document.getElementById('storyView');
      const storyImage = document.getElementById('storyImage');
      const storyText = document.getElementById('storyText');
      const adText = document.getElementById('adText');
      const closeBtn = document.getElementById('closeBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const progressContainer = document.getElementById('progressContainer');
      const closeModalBtn = document.getElementById('closeModalBtn');
  
      let currentStoryIndex = 0;
      let stories = Array.from(document.querySelectorAll('.story-item:not(.add-story)'));
      let intervalId;
  
      addStoryBtn.addEventListener('click', () => {
        addStoryModal.classList.add('show');
      });
  
      closeModalBtn.addEventListener('click', () => {
        addStoryModal.classList.remove('show');
        addAdForm.reset();
      });
  
      storySlider.addEventListener('click', (e) => {
        const storyItem = e.target.closest('.story-item:not(.add-story)');
        if (storyItem) {
          currentStoryIndex = stories.indexOf(storyItem);
          showStory();
        }
      });
  
      closeBtn.addEventListener('click', () => {
        hideStory();
      });
  
      prevBtn.addEventListener('click', () => {
        currentStoryIndex = Math.max(0, currentStoryIndex - 1);
        showStory();
      });
  
      nextBtn.addEventListener('click', () => {
        currentStoryIndex = Math.min(stories.length - 1, currentStoryIndex + 1);
        showStory();
      });
  
      function showStory() {
        if (stories.length === 0) return;
        const story = stories[currentStoryIndex];
        storyImage.src = story.dataset.image || '';
        storyText.textContent = story.dataset.title || '';
        adText.textContent = story.dataset.description || '';
        storyView.classList.add('show');
        updateProgressBars();
        startProgress();
      }
  
      function hideStory() {
        storyView.classList.remove('show');
        clearInterval(intervalId);
        progressContainer.innerHTML = '';
      }
  
      function updateProgressBars() {
        progressContainer.innerHTML = '';
        stories.forEach((_, index) => {
          const bar = document.createElement('div');
          bar.classList.add('progress-bar');
          const progress = document.createElement('div');
          progress.classList.add('progress');
          if (index === currentStoryIndex) {
            progress.style.width = '0%';
          } else if (index < currentStoryIndex) {
            progress.style.width = '100%';
          }
          bar.appendChild(progress);
          progressContainer.appendChild(bar);
        });
      }
  
      function startProgress() {
        clearInterval(intervalId);
        const progressBars = document.querySelectorAll('.progress-bar .progress');
        const currentProgress = progressBars[currentStoryIndex];
        let width = 0;
        intervalId = setInterval(() => {
          width += 1;
          currentProgress.style.width = `${width}%`;
          if (width >= 100) {
            clearInterval(intervalId);
            currentStoryIndex = Math.min(stories.length - 1, currentStoryIndex + 1);
            if (currentStoryIndex < stories.length) {
              showStory();
            } else {
              hideStory();
            }
          }
        }, 50);
      }
    });
  </script>
  <%- include('partials/footer') %>
</body>
</html>
